# Docker Compose para Worker Layer en AWS
# Este archivo está diseñado para ejecutarse en instancias EC2 dedicadas al procesamiento de videos
#
# Arquitectura:
# - Instancias EC2 dedicadas solo a procesamiento de videos
# - Consumen tareas de Redis (compartido con API layer)
# - Acceden a RDS (PostgreSQL compartido)
# - Leen/escriben videos en S3
# - NO exponen API REST
#
# Variables de entorno requeridas:
# - AWS_REGION: Región de AWS (us-east-1 o us-west-2)
# - S3_BUCKET_NAME: Nombre del bucket S3 para videos
# - DB_HOST: Endpoint de Amazon RDS
# - DB_NAME: Nombre de la base de datos en RDS
# - DB_USER: Usuario de RDS
# - DB_PASSWORD: Contraseña de RDS
# - REDIS_URL: Endpoint de Redis (ElastiCache o EC2 con Redis)
# - WORKER_CONCURRENCY: Número de tareas simultáneas (default: 4)

services:
  # Worker - Procesamiento de videos
  worker:
    build:
      context: ./back
      dockerfile: Dockerfile.worker
    container_name: anb_worker
    command: ./worker
    environment:
      - TZ=America/Bogota

      # Database - Amazon RDS PostgreSQL
      - DB_DRIVER=${DB_DRIVER:-postgres}
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-proyecto_1}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-password}
      - DB_SSL_MODE=${DB_SSL_MODE:-disable}

      # Redis - Compartido con API layer
      - REDIS_URL=${REDIS_URL:-redis:6379}

      # Worker configuration
      - WORKER_MODE=${WORKER_MODE:-true}
      - ENVIRONMENT=production
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}

      # Storage - Amazon S3
      - STORAGE_TYPE=${STORAGE_TYPE:-local}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-anb-videos-bucket}
      - S3_UPLOAD_PREFIX=${S3_UPLOAD_PREFIX:-uploads}
      - S3_PROCESSED_PREFIX=${S3_PROCESSED_PREFIX:-processed}

      # Legacy paths (no se usan con S3)
      - UPLOAD_PATH=${UPLOAD_PATH:-/app/uploads}
      - PROCESSED_PATH=${PROCESSED_PATH:-/app/processed}

      # Limits
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-104857600}
      
      # Video processing settings
      - MAX_VIDEO_DURATION=${MAX_VIDEO_DURATION:-104857600}
      - OUTPUT_RESOLUTION=${OUTPUT_RESOLUTION:-1280x720}
      - OUTPUT_ASPECT_RATIO=${OUTPUT_ASPECT_RATIO:-16:9}
      
    # volumes:
    #       # Montaje del NFS compartido
    #       - /mnt/nfs/uploads:/app/uploads
    #       - /mnt/nfs/processed:/app/processed
    
    # Almacenamiento en local
    volumes:
      - video_uploads:/app/uploads
      - video_processed:/app/processed
    networks:
      - anb_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.8'
          memory: 1600M
        reservations:
          cpus: '1.0'
          memory: 1024M
    healthcheck:
      test: ["CMD", "pgrep", "-f", "worker"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

# Almacenamiento en local
volumes:
  video_uploads:
  video_processed:

networks:
  anb_network:
    external: true
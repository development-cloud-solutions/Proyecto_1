AWSTemplateFormatVersion: '2010-09-09'
Description: 'ANB Rising Stars - Auto Scaling Group for Worker Instances (Video Processing)'

Parameters:
  EnvironmentName:
    Description: Environment name prefix (must match other stacks)
    Type: String
    Default: anb-production

  KeyPairName:
    Description: EC2 Key Pair for SSH access
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be the name of an existing EC2 KeyPair

  WorkerInstanceType:
    Description: EC2 instance type for Worker servers
    Type: String
    Default: t3.small
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium
      - t2.micro
      - t2.small
      - t2.medium

  LatestAmiId:
    Description: Latest Amazon Linux 2023 AMI ID
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64

  MinSize:
    Description: Minimum number of worker instances
    Type: Number
    Default: 1
    MinValue: 0
    MaxValue: 3

  MaxSize:
    Description: Maximum number of worker instances
    Type: Number
    Default: 3
    MinValue: 1
    MaxValue: 6

  DesiredCapacity:
    Description: Desired number of worker instances
    Type: Number
    Default: 1
    MinValue: 0

  WorkerConcurrency:
    Description: Number of concurrent video processing tasks per worker
    Type: Number
    Default: 4
    MinValue: 1
    MaxValue: 12

  TargetQueueDepth:
    Description: Target queue depth per worker for scaling
    Type: Number
    Default: 10
    MinValue: 1
    MaxValue: 100

  DBPassword:
    Description: Database password
    Type: String
    NoEcho: true

  DBHost:
    Description: Database endpoint address
    Type: String

  DBName:
    Description: Database name
    Type: String
    Default: proyecto_1

  DBUsername:
    Description: Database username
    Type: String
    Default: postgres

  S3BucketName:
    Description: S3 bucket name for video storage
    Type: String

  DeploymentPackageS3Key:
    Description: S3 key for deployment package
    Type: String
    Default: deployments/latest/app.tar.gz

  SQSQueueURL:
    Description: SQS Queue URL for video processing
    Type: String

  InstanceSecurityGroup:
    Description: Security Group ID for EC2 instances
    Type: String

Resources:
  # Launch Template para Worker Instances
  WorkerLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${EnvironmentName}-worker-launch-template'
      LaunchTemplateData:
        ImageId: !Ref LatestAmiId
        InstanceType: !Ref WorkerInstanceType
        KeyName: !Ref KeyPairName
        IamInstanceProfile:
          Name: LabInstanceProfile
        SecurityGroupIds:
          - !Ref InstanceSecurityGroup
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 30
              VolumeType: gp3
              DeleteOnTermination: true
              Encrypted: true
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            exec > >(tee /var/log/user-data.log)
            exec 2>&1

            echo "=========================================="
            echo "Iniciando configuración de Worker"
            echo "Hora: $(date)"
            echo "=========================================="

            # Actualizar sistema
            yum update -y
            yum install -y docker git wget telnet

            # Instalar cliente de postgres
            yum install -y postgresql15

            # Iniciar Docker
            systemctl enable docker
            systemctl start docker
            usermod -aG docker ec2-user

            # Instalar Docker Compose
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose

            # Instalar AWS CLI v2
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            ./aws/install
            rm -rf aws awscliv2.zip

            # Crear directorio de aplicación
            APP_DIR="/opt/anb-worker"
            mkdir -p ${!APP_DIR}
            cd ${!APP_DIR}

            # Esperar credenciales de IAM
            echo "Esperando credenciales de IAM..."
            MAX_ATTEMPTS=30
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                if aws sts get-caller-identity --region ${AWS::Region} > /dev/null 2>&1; then
                    echo "✓ Credenciales de IAM disponibles"
                    break
                fi
                ATTEMPT=$((ATTEMPT + 1))
                sleep 10
            done

            # Descargar código desde S3
            S3_BUCKET="${S3BucketName}"
            echo "Descargando app.tar.gz desde s3://${!S3_BUCKET}/${DeploymentPackageS3Key}"
            aws s3 cp s3://${!S3_BUCKET}/${DeploymentPackageS3Key} app.tar.gz --region ${AWS::Region}

            if [ ! -f app.tar.gz ]; then
                echo "✗ ERROR: No se pudo descargar app.tar.gz"
                exit 1
            fi

            tar -xzf app.tar.gz
            rm app.tar.gz

            # Crear red Docker
            docker network create anb_network || true

            # Configurar variables de entorno con SQS
            cat > ${!APP_DIR}/.env << 'EOF'
            # AWS Configuration
            AWS_REGION=${AWS::Region}
            S3_BUCKET_NAME=${S3BucketName}
            S3_UPLOAD_PREFIX=uploads
            S3_PROCESSED_PREFIX=processed

            # Database Configuration
            DB_HOST=${DBHost}
            DB_PORT=5432
            DB_NAME=${DBName}
            DB_USER=${DBUsername}
            DB_PASSWORD=${DBPassword}
            DB_SSL_MODE=require

            # Queue Configuration - SQS
            QUEUE_TYPE=sqs
            SQS_REGION=${AWS::Region}
            SQS_QUEUE_URL=${SQSQueueURL}

            # Worker Configuration
            WORKER_MODE=true
            WORKER_CONCURRENCY=${WorkerConcurrency}
            ENVIRONMENT=production

            # Application Configuration
            STORAGE_TYPE=s3

            # Limits
            MAX_FILE_SIZE=104857600
            MAX_VIDEO_DURATION=30
            OUTPUT_RESOLUTION=1280x720
            OUTPUT_ASPECT_RATIO=16:9
            EOF

            # Copiar .env a back/
            mkdir -p ${!APP_DIR}/back
            cp ${!APP_DIR}/.env ${!APP_DIR}/back/.env

            # Construir y levantar worker
            export DOCKER_BUILDKIT=0
            export COMPOSE_DOCKER_CLI_BUILD=0

            docker-compose -f docker-compose.worker.yml build --no-cache
            docker-compose -f docker-compose.worker.yml up -d

            # Health check
            echo "Verificando que el worker está en ejecución..."
            sleep 20

            if docker ps | grep -q anb_worker; then
                echo "✓ Worker está en ejecución"
                docker logs anb_worker --tail 50
            else
                echo "✗ ERROR: El worker no se inició"
                docker-compose -f docker-compose.worker.yml logs
                exit 1
            fi

            echo "=========================================="
            echo "Worker configurado exitosamente"
            echo "=========================================="
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${EnvironmentName}-worker-asg'
              - Key: Environment
                Value: !Ref EnvironmentName
              - Key: Type
                Value: Worker
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: !Sub '${EnvironmentName}-worker-volume'

  # Auto Scaling Group para Workers
  WorkerAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub '${EnvironmentName}-worker-asg'
      LaunchTemplate:
        LaunchTemplateId: !Ref WorkerLaunchTemplate
        Version: !GetAtt WorkerLaunchTemplate.LatestVersionNumber
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      HealthCheckType: EC2
      HealthCheckGracePeriod: 600  # 10 minutos
      VPCZoneIdentifier:
        - Fn::ImportValue: !Sub '${EnvironmentName}-PublicSubnet1'
        - Fn::ImportValue: !Sub '${EnvironmentName}-PublicSubnet2'
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-worker-asg'
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref EnvironmentName
          PropagateAtLaunch: true
        - Key: Type
          Value: Worker
          PropagateAtLaunch: true

  # Scaling Policy basada en profundidad de cola SQS
  # Escala cuando el número de mensajes supera TargetQueueDepth (default: 10)
  # Ejemplo: Si TargetQueueDepth=10 y hay 30 mensajes, escala a ~3 workers
  WorkerScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref WorkerAutoScalingGroup
      PolicyType: TargetTrackingScaling
      EstimatedInstanceWarmup: 180
      TargetTrackingConfiguration:
        CustomizedMetricSpecification:
          MetricName: ApproximateNumberOfMessagesVisible
          Namespace: AWS/SQS
          Dimensions:
            - Name: QueueName
              Value:
                Fn::ImportValue: !Sub '${EnvironmentName}-SQSQueueName'
          Statistic: Average
        TargetValue: !Ref TargetQueueDepth
        DisableScaleIn: false

  # CloudWatch Alarms para Workers
  WorkerHighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${EnvironmentName}-worker-asg-high-cpu'
      AlarmDescription: Alert when Worker ASG average CPU exceeds 85%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 85
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WorkerAutoScalingGroup

  WorkerLowCapacityAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${EnvironmentName}-worker-asg-low-capacity'
      AlarmDescription: Alert when no workers are running
      MetricName: GroupInServiceInstances
      Namespace: AWS/AutoScaling
      Statistic: Average
      Period: 60
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref WorkerAutoScalingGroup

Outputs:
  AutoScalingGroupName:
    Description: Name of the Worker Auto Scaling Group
    Value: !Ref WorkerAutoScalingGroup
    Export:
      Name: !Sub '${EnvironmentName}-WorkerASGName'

  LaunchTemplateId:
    Description: ID of the Worker Launch Template
    Value: !Ref WorkerLaunchTemplate
    Export:
      Name: !Sub '${EnvironmentName}-WorkerLaunchTemplateId'
